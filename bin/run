#!/usr/bin/env bash
set -eo pipefail

# default variables
: "${PORT:=8000}"
: "${SLEEP:=1}"
: "${TRIES:=60}"

usage() {
  echo "usage: bin/run web|web-dev|test"
  exit 1
}

[ $# -lt 1 ] && usage

case $1 in
  web)
    #exec newrelic-admin run-program gunicorn taar_api.app:app -b 0.0.0.0:${PORT} --workers 4 --access-logfile -
    exec python taar_api/app.py # TODO: need to be able to pass in port to flask
    ;;
  web-dev)
    exec python taar_api/app.py # TODO: need to be able to pass in port to flask
    ;;
  test)
    coverage erase
    tox
    coverage report -m
    if [[ ! -z ${CI+check} ]]; then
      # submit coverage
      coverage xml
      env
      bash <(curl -s https://codecov.io/bash) -s /tmp
    fi
    ;;
  *)
    exec "$@"
    ;;
esac
